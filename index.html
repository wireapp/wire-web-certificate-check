<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Wire Certificate Check</title>
    <script>
      const {ipcRenderer, shell} = require('electron');
      let log = `Wire Certificate Check log from ${new Date().toISOString()}\n\n`;

      window.$ = window.jQuery = require('jquery');
      $(() => {
        ipcRenderer.on('hostnames', (event, hostnames) => hostnames.forEach(hostname => {
          $('#hostnames').append($(`<div id="host-${hostname.replace(/\./g, '-')}"></div>`)
            .append($(`<span>${hostname}</span><span class="status"></span>`)))
        }));

        ipcRenderer.on('result', (event, data) => {
          const {hostname, result} = data;
          const {errorMessage = '', verifiedPublicKeyInfo} = result;
          let icon;
          if (verifiedPublicKeyInfo === true) {
            icon = '✔️';
          } else {
            icon = '❌';
            $('#status').html('At least one check failed.');
            $('#sendmail').show();
            log += `${hostname}: ${errorMessage}\n`;
          }
          $(`#host-${hostname.replace(/\./g, '-')} .status`).html(icon);
        });

        $(document).on('click', '#start', () => ipcRenderer.send('start-verification'));
        $(document).on('click', '#sendmail', event => {
          event.preventDefault();
          shell.openExternal(`mailto:support@wire.com?subject=${encodeURIComponent('Certificate Check Report')}&body=${encodeURIComponent(log)}`);
        });

        ipcRenderer.send('jquery-ready');
      });
    </script>
    <style>
      body {
        font-family: Arial, sans-serif;
      }

      #sendmail {
        display: none;
      }
    </style>
  </head>
  <body>
    <h1>Wire Certificate Check</h1>
    <h2>Testing domains:</h2>
    <div id="hostnames"></div>
    <br>
    <span id="status"></span> <button id="sendmail">Send log via email</button>
  </body>
</html>
